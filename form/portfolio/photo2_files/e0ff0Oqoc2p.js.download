;/*FB_PKG_DELIM*/

__d("LSIssueAttachmentsRangeQuery",["LSGetCursor","LSIssueNewTask"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(a){return c.storedProcedure(b("LSGetCursor"),c.i64.cast([0,1])).then(function(a){return a=a,d[0]=a[0],a})},function(e){return c.db.table(17).fetch([[[a[0],a[1]]]]).next().then(function(e,f){var g=e.done;e=e.value;return g?c.sequence([function(b){return c.db.table(9).fetch([[[a[0]]]]).next().then(function(b,e){var a=b.done;b=b.value;return a?d[2]=c.i64.cast([0,1]):(e=b.item,d[7]=e.syncGroup,c.i64.neq(d[7],void 0)?d[6]=d[7]:d[6]=c.i64.cast([0,1]),d[2]=d[6])})},function(e){return d[4]=new c.Map(),d[4].set("thread_key",a[0]),d[4].set("media_group",a[1]),d[4].set("max_timestamp_ms",c.i64.cast([2328,1316134911])),d[4].set("cursor",d[0]),d[4].set("sync_group",d[2]),d[4].set("last_loaded_message_id",void 0),d[5]=c.toJSON(d[4]),c.storedProcedure(b("LSIssueNewTask"),"arq",c.i64.cast([0,105]),d[5],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))}]):(f=e.item,f.hasMoreBefore?c.sequence([function(b){return c.db.table(9).fetch([[[a[0]]]]).next().then(function(b,e){var a=b.done;b=b.value;return a?d[2]=c.i64.cast([0,1]):(e=b.item,d[7]=e.syncGroup,c.i64.neq(d[7],void 0)?d[6]=d[7]:d[6]=c.i64.cast([0,1]),d[2]=d[6])})},function(e){return d[4]=new c.Map(),d[4].set("thread_key",a[0]),d[4].set("media_group",a[1]),d[4].set("max_timestamp_ms",f.minTimestampMs),d[4].set("cursor",d[0]),d[4].set("sync_group",d[2]),d[4].set("last_loaded_message_id",void 0),d[5]=c.toJSON(d[4]),c.storedProcedure(b("LSIssueNewTask"),"arq",c.i64.cast([0,105]),d[5],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))}]):c.resolve())})}])},function(a){return c.resolve(e)}])}e.exports=a}),null);
__d("LSIssueAttachmentsRangeQueryStoredProcedure",["LSIssueAttachmentsRangeQuery","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){var d=[];d[0]=b.threadKey;d[1]=b.mediaGroup;return c("LSIssueAttachmentsRangeQuery").apply(void 0,d.concat([a]))}g["default"]=a}),98);
__d("MWSharedAttachmentsSectionHooks",["I64","LSIntEnum","LSThreadMediaGalleryGroup","MessagingAttachmentType","ReQL","ReQLSuspense","qex","react","usePrevious","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=k||d("react"),m=l.useCallback,n=l.useEffect,o=l.useState;function a(a){var b=a.attachmentsRange,d=a.hasMore,e=a.loadMore,f=a.logLoadMediaCancel,g=a.logLoadMediaSuccess,h=a.media,i=a.skipInitialLoad;a=o(!1);var j=a[0],k=a[1],l=h.length,p=(a=c("usePrevious")(l))!=null?a:0,q=c("usePrevious")(d),r=(h=c("usePrevious")(j))!=null?h:!1;n(function(){b==null&&i!==!0&&(e(),c("qex")._("89")===!0&&k(!0))},[b,e,i]);n(function(){var a=p!==l,f=q===!0&&!d||b==null&&d===!1&&q===!1&&p===l&&c("qex")._("89")===!0;j&&(f||a)?(k(!1),g==null?void 0:g({fetchedMediaCount:l-p,startMediaCount:p})):p===l&&d&&j&&r===!0&&c("qex")._("89")===!0&&(g==null?void 0:g({fetchedMediaCount:l-p,isAlreadyPreloaded:!0,startMediaCount:p}),e())},[l,d,j,p,q,b,e,r,g,f]);a=m(function(){if(!j){e();return k(!0)}},[j,e,k]);h=l>0||!j&&!d;return[j,a,h]}function p(a,b,e,g){var j;g=g===void 0?{}:g;g=g.removeUnsentMessages;var k=g===void 0?!1:g,l=(h||(h=c("useReStore")))();g=d("ReQLSuspense").useFirst(function(){return d("ReQL").fromTableDescending(l.tables.attachments_ranges_v2__generated).getKeyRange(a).filter(function(a){return(i||(i=d("I64"))).equal(a.mediaGroup,b)})},[l,a,b],f.id+":139");var n=g==null?void 0:g.minTimestampMs;j=c("qex")._("89")===!0?g==null?void 0:g.hasMoreBefore:(j=g==null?void 0:g.hasMoreBefore)!=null?j:!1;var o=m(function(a){if(!e(a))return null;if(!k)return a;var b=d("ReQLSuspense").first(d("ReQL").fromTableAscending(l.tables.messages.index("messageId")).getKeyRange(a.messageId),f.id+":161");return b==null||b.isUnsent?null:a},[l,e,k]),p=d("ReQLSuspense").useArray(function(){var b=d("ReQL").fromTableDescending(l.tables.attachments.index("fk_messages")).getKeyRange(a);return b.map(o).filter(Boolean)},[l,a,o],f.id+":174");return[p,g,n,j]}function q(a){var b=a.attachmentType;a=a.defaultCtaType;return(i||(i=d("I64"))).equal(b,(j||(j=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").XMA))?a==="xma_web_url":!1}function b(a,b){a=p(a,(j||(j=d("LSIntEnum"))).ofNumber(c("LSThreadMediaGalleryGroup").LINKS),q,b);b=a[0];var e=a[1],f=a[2];a=a[3];return[b,j.ofNumber(c("LSThreadMediaGalleryGroup").LINKS),e,f,a]}function r(a){a=a.attachmentType;return(i||(i=d("I64"))).equal(a,(j||(j=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").IMAGE))||(i||(i=d("I64"))).equal(a,(j||(j=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").VIDEO))}function e(a,b){a=p(a,(j||(j=d("LSIntEnum"))).ofNumber(c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),r,b);b=a[0];var e=a[1],f=a[2];a=a[3];return[b,j.ofNumber(c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),e,f,a]}function s(a){a=a.attachmentType;return(i||(i=d("I64"))).equal(a,(j||(j=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").FILE))}function t(a,b){a=p(a,(j||(j=d("LSIntEnum"))).ofNumber(c("LSThreadMediaGalleryGroup").FILES_ONLY),s,b);b=a[0];var e=a[1],f=a[2];a=a[3];return[b,j.ofNumber(c("LSThreadMediaGalleryGroup").FILES_ONLY),e,f,a]}g.useLoader=a;g.useQueryLinkAttachments=b;g.useQueryMediaAttachments=e;g.useQueryFileAttachments=t}),98);
__d("queryMWLSOtherParticipantContact",["I64","LSMessagingThreadTypeUtil","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,e,f){c=d("LSMessagingThreadTypeUtil").isOneToOne(c);return c?d("ReQL").leftJoin(d("ReQL").fromTableAscending(a.tables.participants,["contactId"]).getKeyRange(b).filter(function(a){return!(h||(h=d("I64"))).equal(a.contactId,e)}).take(1),d("ReQL").fromTableAscending(a.tables.contacts,f)).map(function(a){a[0];a=a[1];return a}):d("ReQL").empty()}g["default"]=a}),98);
__d("useLoadMoreThreadSharedAttachments.react",["Int64Hooks","LSFactory","LSIssueAttachmentsRangeQueryStoredProcedure","MAWThreadCutover","MWThreadKey.react","promiseDone","qex","useAsyncReStore"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=c("useAsyncReStore")(),g=d("MWThreadKey.react").useMWThreadKeyMemoizedExn(),h=d("MAWThreadCutover").useGetCutoverOpenThreadKey(g);return d("Int64Hooks").useCallbackInt64(function(){b==null?void 0:b(),c("promiseDone")(e,function(b){return b.runInTransaction(function(b){return c("LSIssueAttachmentsRangeQueryStoredProcedure")(c("LSFactory")(b),{mediaGroup:a,threadKey:h&&c("qex")._("89")===!0?h:g})},"readwrite",void 0,void 0,f.id+":36")})},[b,e,a,h,g])}g["default"]=a}),98);
__d("useMAWLoadMoreThreadSharedAttachments",["I64","Int64Hooks","MAWBridgeSendAndReceive","MAWMiActOnActThreadReady","promiseDone","qex","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=(i||(i=d("I64"))).of_string("9999999999999");function a(a,b,e,f,g){var k=(h||(h=c("useReStore")))(),l=d("Int64Hooks").useCallbackInt64(function(){return b!=null&&b&&e!=null?c("qex")._("89")===!0?(i||(i=d("I64"))).to_float(e):(i||(i=d("I64"))).to_int32(e):c("qex")._("89")===!0?Number.MAX_SAFE_INTEGER:(i||(i=d("I64"))).to_int32(j)},[b,e]);return d("Int64Hooks").useCallbackInt64(function(){a!=null&&(g==null?void 0:g(),c("promiseDone")(d("MAWMiActOnActThreadReady").onActThreadReady(k.tables,a,"useMAWLoadMoreThreadSharedAttachments",function(a,b){return d("MAWBridgeSendAndReceive").sendAndReceive("backend","loadMoreMedia",{earliestLoadedMediaMessageId:f,earliestLoadedMediaTs:l(),threadJid:b})})))},[a,g,k.tables,f,l])}g["default"]=a}),98);
__d("useMWMediaLoadingQplLogger",["MWMediaRenderQplUtils","QPLUserFlow","QuickPerformanceLogger","Random","qex","qpl","react"],(function(a,b,c,d,e,f,g){"use strict";var h,i;b=i||d("react");var j=b.useEffect,k=b.useMemo;function a(a){var b=a.entrypoint,d=a.threadType,e=k(function(){return o()},[]);j(function(){return function(){var a=(h||(h=c("QuickPerformanceLogger"))).isMarkerOn(c("qpl")._(25300395,"1954"),e);a&&i()}},[]);var f=function(a){var f;if(!c("qex")._("89")===!0)return;l({entrypoint:b,instanceKey:e,isCutoverThread:(f=a==null?void 0:a.isCutoverThread)!=null?f:!1,isPreCutoverMedia:(f=a==null?void 0:a.isPreCutoverMedia)!=null?f:!1,threadType:d})},g=function(a){var b=a.fetchedMediaCount,d=a.isAlreadyPreloaded;a=a.startMediaCount;if(!c("qex")._("89")===!0)return;m({fetchedMediaCount:b,instanceKey:e,isAlreadyPreloaded:d,startMediaCount:a})},i=function(){if(!c("qex")._("89")===!0)return;n({instanceKey:e})};return k(function(){return{logLoadMediaCancel:i,logLoadMediaStart:f,logLoadMediaSuccess:g}},[])}function l(a){var b=a.entrypoint,e=a.instanceKey,f=a.isCutoverThread;f=f===void 0?!1:f;var g=a.isPreCutoverMedia;g=g===void 0?!1:g;a=a.threadType;c("QPLUserFlow").start(c("qpl")._(25300395,"1954"),{annotations:{bool:{isCutoverThread:f,isPreCutoverMedia:g},string:{entrypoint:b,threadType:d("MWMediaRenderQplUtils").getThreadTypeStringFromEnum(a)}},cancelOnUnload:!0,instanceKey:e,timeoutInMs:60*1e3})}function m(a){var b=a.fetchedMediaCount,d=a.instanceKey,e=a.isAlreadyPreloaded;a=a.startMediaCount;c("QPLUserFlow").endSuccess(c("qpl")._(25300395,"1954"),{annotations:{bool:{isAlreadyPreloaded:(e=e)!=null?e:!1},"int":{fetchedMediaCount:b,startMediaCount:a}},instanceKey:d})}function n(a){a=a.instanceKey;c("QPLUserFlow").endCancel(c("qpl")._(25300395,"1954"),{instanceKey:a})}function o(){return Date.now()+Math.round(d("Random").random()*1e4)}g["default"]=a}),98);
__d("useMAWLoadMoreCutoverThreadSharedAttachments",["MAWDbMsg","MWSharedAttachmentsSectionHooks","react","useLoadMoreThreadSharedAttachments.react","useMAWLoadMoreThreadSharedAttachments","useMWMediaLoadingQplLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i=(h||d("react")).useCallback;function a(a,b,e){var f,g=d("MWSharedAttachmentsSectionHooks").useQueryMediaAttachments(a),h=g[0],j=g[1],k=g[2],l=g[3];g=g[4];f=(f=g)!=null?f:!0;var m=(k==null?void 0:k.lastLoadedMessageId)!=null?d("MAWDbMsg").toMsgId(k==null?void 0:k.lastLoadedMessageId):void 0,n=c("useMWMediaLoadingQplLogger")({entrypoint:e.entrypoint,threadType:e.threadType});e=i(function(){n.logLoadMediaStart({isCutoverThread:!0,isPreCutoverMedia:!1})},[n]);g=c("useMAWLoadMoreThreadSharedAttachments")(a,g,l,(a=m)!=null?a:void 0,e);l=d("MWSharedAttachmentsSectionHooks").useQueryMediaAttachments(b);m=l[0];a=l[2];e=l[4];l=(b=e)!=null?b:!1;e=i(function(){n.logLoadMediaStart({isCutoverThread:!0,isPreCutoverMedia:!0})},[n]);b=c("useLoadMoreThreadSharedAttachments.react")(j,e);j=d("MWSharedAttachmentsSectionHooks").useLoader({attachmentsRange:k,hasMore:f,loadMore:g,logLoadMediaCancel:n.logLoadMediaCancel,logLoadMediaSuccess:n.logLoadMediaSuccess,media:h});e=j[0];k=j[1];g=j[2];j=d("MWSharedAttachmentsSectionHooks").useLoader({attachmentsRange:a,hasMore:l,loadMore:b,logLoadMediaCancel:n.logLoadMediaCancel,logLoadMediaSuccess:n.logLoadMediaSuccess,media:m,skipInitialLoad:f||e});a=j[0];b=j[1];j=j[2];if(f||e)return{attachments:h,completedFirstLoad:g,hasMore:f,isLoadingMore:e,onLoadMore:k};else if(l||a)return{attachments:h.concat(m),completedFirstLoad:j,hasMore:l,isLoadingMore:a,onLoadMore:b};else return{attachments:h.concat(m),completedFirstLoad:!0,hasMore:!1,isLoadingMore:!1,onLoadMore:function(){}}}g["default"]=a}),98);